name: Pip Install Test Suite

on:
  workflow_dispatch:

jobs:
  pip-test:
    name: Test on ${{ matrix.os }} (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout code (for tests only)
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install numchuck from PyPI and test dependencies
        run: |
          pip install numchuck pytest numpy

      - name: Verify using installed package (not local src)
        run: |
          python -c "
          import numchuck
          import os
          # Verify the package is installed from site-packages, not local src/
          pkg_path = numchuck.__file__
          assert 'site-packages' in pkg_path, f'Expected site-packages in path, got: {pkg_path}'
          print(f'numchuck installed at: {pkg_path}')
          print(f'numchuck version: {numchuck.__version__}')
          "

      - name: Run tests
        run: |
          # Run from tests/ dir to avoid importing local src/
          # Skip: realtime (no audio device), wavfile (WvOut timing), chugin (not bundled)
          cd tests
          pytest . -v --tb=short -k "not realtime and not wavfile and not chugin"
