name: Render Test

on:
  workflow_dispatch:

jobs:
  render-test:
    name: Render test on ${{ matrix.os }} (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Create virtual environment (Unix)
        if: runner.os != 'Windows'
        run: |
          python -m venv venv
          source venv/bin/activate
          python --version
          pip --version

      - name: Create virtual environment (Windows)
        if: runner.os == 'Windows'
        run: |
          python -m venv venv
          .\venv\Scripts\activate
          python --version
          pip --version

      - name: Install numchuck (Unix)
        if: runner.os != 'Windows'
        run: |
          source venv/bin/activate
          pip install numchuck

      - name: Install numchuck (Windows)
        if: runner.os == 'Windows'
        run: |
          .\venv\Scripts\activate
          pip install numchuck

      - name: Test import (Unix)
        if: runner.os != 'Windows'
        run: |
          source venv/bin/activate
          python -c "
          import numchuck
          from numchuck import Chuck
          print(f'numchuck version: {numchuck.__version__}')

          # Test extension import
          from numchuck._numchuck import ChucK as RawChucK
          print(f'ChucK version: {RawChucK.version()}')

          # Basic instantiation test
          chuck = Chuck()
          print(f'Sample rate: {chuck.sample_rate}')
          print('Import test passed!')
          "

      - name: Test import (Windows)
        if: runner.os == 'Windows'
        run: |
          .\venv\Scripts\activate
          python -c "import numchuck; from numchuck import Chuck; print(f'numchuck version: {numchuck.__version__}'); from numchuck._numchuck import ChucK as RawChucK; print(f'ChucK version: {RawChucK.version()}'); chuck = Chuck(); print(f'Sample rate: {chuck.sample_rate}'); print('Import test passed!')"

      - name: Render ChucK example to WAV (Unix)
        if: runner.os != 'Windows'
        run: |
          source venv/bin/activate
          python -c "
          import os
          from numchuck import Chuck

          # Read the example file
          with open('examples/basic/foo.ck', 'r') as f:
              code = f.read()

          # Initialize ChucK
          sample_rate = 44100
          duration_sec = 3
          num_frames = sample_rate * duration_sec
          output_filename = '${{ matrix.os }}_output.wav'

          chuck = Chuck(sample_rate=sample_rate, output_channels=2)

          # Compile the audio-generating code
          success, shred_ids = chuck.compile(code)
          assert success, 'Failed to compile foo.ck'
          print(f'Compiled foo.ck, shred IDs: {shred_ids}')

          # Add a recording shred using ChucK's native WvOut
          record_code = '''
          dac => WvOut w => blackhole;
          \"''' + output_filename + '''\" => w.wavFilename;
          ''' + str(duration_sec) + '''::second => now;
          w.closeFile();
          '''
          success, rec_ids = chuck.compile(record_code)
          assert success, 'Failed to compile recording shred'
          print(f'Recording shred ID: {rec_ids}')

          # Run for the duration
          chuck.run(num_frames)
          print(f'Rendered {duration_sec} seconds of audio')

          # Verify the file
          file_size = os.path.getsize(output_filename)
          print(f'Wrote {output_filename} ({file_size} bytes)')
          assert file_size > 1000, 'WAV file too small'
          print('Render test passed!')
          "

      - name: Render ChucK example to WAV (Windows)
        if: runner.os == 'Windows'
        run: |
          .\venv\Scripts\activate
          python -c "import os; from numchuck import Chuck; code = open('examples/basic/foo.ck', 'r').read(); sample_rate = 44100; duration_sec = 3; num_frames = sample_rate * duration_sec; output_filename = '${{ matrix.os }}_output.wav'; chuck = Chuck(sample_rate=sample_rate, output_channels=2); success, shred_ids = chuck.compile(code); assert success, 'Failed to compile foo.ck'; print(f'Compiled foo.ck, shred IDs: {shred_ids}'); record_code = 'dac => WvOut w => blackhole; \"' + output_filename + '\" => w.wavFilename; ' + str(duration_sec) + '::second => now; w.closeFile();'; success, rec_ids = chuck.compile(record_code); assert success, 'Failed to compile recording shred'; print(f'Recording shred ID: {rec_ids}'); chuck.run(num_frames); print(f'Rendered {duration_sec} seconds of audio'); file_size = os.path.getsize(output_filename); print(f'Wrote {output_filename} ({file_size} bytes)'); assert file_size > 1000, 'WAV file too small'; print('Render test passed!')"

      - name: Upload rendered WAV
        uses: actions/upload-artifact@v4
        with:
          name: rendered-wav-${{ matrix.os }}-py${{ matrix.python-version }}
          path: ${{ matrix.os }}_output.wav
          retention-days: 7
